"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3233],{3233:(k,P,d)=>{d.r(P),d.d(P,{MarcarPageModule:()=>W});var C=d(177),N=d(4341),l=d(4742),b=d(4964),u=d(467),i=d(3953),R=d(7133),S=d(2518),y=d(5083),E=function(e){return e.Front="FRONT",e.Back="BACK",e}(E||{});const A=(0,y.F3)("BarcodeScanner",{web:()=>d.e(870).then(d.bind(d,870)).then(e=>new e.BarcodeScannerWeb)}),O=["square"];function F(e,f){if(1&e){const h=i.RV6();i.j41(0,"ion-fab",8)(1,"ion-fab-button",4),i.bIt("click",function(){i.eBV(h);const n=i.XpG();return i.Njj(n.toggleTorch())}),i.nrm(2,"ion-icon",9),i.k0s()()}}let L=(()=>{var e;class f{constructor(t,n){this.ngZone=t,this.modalController=n,this.formats=[],this.lensFacing=E.Back,this.isTorchAvailable=!1}ngOnInit(){A.isTorchAvailable().then(t=>{this.isTorchAvailable=t.available})}ngAfterViewInit(){setTimeout(()=>{this.startScan()},250)}ngOnDestroy(){this.stopScan()}closeModal(t){var n=this;return(0,u.A)(function*(){n.modalController.dismiss({barcode:t})})()}toggleTorch(){return(0,u.A)(function*(){yield A.toggleTorch()})()}startScan(){var t=this;return(0,u.A)(function*(){var n,o;null===(n=document.querySelector("body"))||void 0===n||n.classList.add("barcode-scanning-active");const a={formats:t.formats,lensFacing:t.lensFacing},c=null===(o=t.squareElement)||void 0===o?void 0:o.nativeElement.getBoundingClientRect(),r=c?{left:c.left*window.devicePixelRatio,right:c.right*window.devicePixelRatio,top:c.top*window.devicePixelRatio,bottom:c.bottom*window.devicePixelRatio,width:c.width*window.devicePixelRatio,height:c.height*window.devicePixelRatio}:void 0,s=r?[[r.left,r.top],[r.left+r.width,r.top],[r.left+r.width,r.top+r.height],[r.left,r.top+r.height]]:void 0,g=yield A.addListener("barcodeScanned",function(){var p=(0,u.A)(function*(v){t.ngZone.run(()=>{const m=v.barcode.cornerPoints;s&&m&&(s[0][0]>m[0][0]||s[0][1]>m[0][1]||s[1][0]<m[1][0]||s[1][1]>m[1][1]||s[2][0]<m[2][0]||s[2][1]<m[2][1]||s[3][0]>m[3][0]||s[3][1]<m[3][1])||(g.remove(),t.closeModal(v.barcode))})});return function(v){return p.apply(this,arguments)}}());yield A.startScan(a)})()}stopScan(){return(0,u.A)(function*(){var t;null===(t=document.querySelector("body"))||void 0===t||t.classList.remove("barcode-scanning-active"),yield A.stopScan()})()}}return(e=f).\u0275fac=function(t){return new(t||e)(i.rXU(i.SKi),i.rXU(l.W3))},e.\u0275cmp=i.VBU({type:e,selectors:[["app-barcode-scanning"]],viewQuery:function(t,n){if(1&t&&i.GBs(O,5),2&t){let o;i.mGM(o=i.lsd())&&(n.squareElement=o.first)}},inputs:{formats:"formats",lensFacing:"lensFacing"},decls:9,vars:1,consts:[["square",""],[1,"ion-no-border"],["color","tertiary"],["slot","end"],[3,"click"],["name","close"],[1,"square"],["slot","fixed","horizontal","end","vertical","bottom",4,"ngIf"],["slot","fixed","horizontal","end","vertical","bottom"],["name","flashlight"]],template:function(t,n){if(1&t){const o=i.RV6();i.j41(0,"ion-header",1)(1,"ion-toolbar",2)(2,"ion-buttons",3)(3,"ion-button",4),i.bIt("click",function(){return i.eBV(o),i.Njj(n.closeModal())}),i.nrm(4,"ion-icon",5),i.k0s()()()(),i.j41(5,"ion-content"),i.nrm(6,"div",6,0),i.DNE(8,F,3,0,"ion-fab",7),i.k0s()}2&t&&(i.R7$(8),i.Y8G("ngIf",n.isTorchAvailable))},dependencies:[C.bT,l.Jm,l.QW,l.W9,l.Q8,l.YW,l.eU,l.iq,l.ai],styles:["ion-content[_ngcontent-%COMP%]{--background: transparent}.square[_ngcontent-%COMP%]{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);border-radius:16px;width:200px;height:200px;border:6px solid white;box-shadow:0 0 0 4000px #0000004d}"]}),f})();var T=d(7762),x=d(9415);const w=[{path:"",component:(()=>{var e;class f{constructor(t,n,o,a){this.alertController=t,this.menuCtrl=n,this.modalController=o,this.route=a,this.firebaseSvc=(0,i.WQX)(R.f),this.utilsSvc=(0,i.WQX)(S.T),this.ScanResult=""}ngOnInit(){this.route.paramMap.subscribe(t=>{const n=t.get("seccionId");n&&this.loadSeccionAndAsignatura(n)})}loadSeccionAndAsignatura(t){var n=this;return(0,u.A)(function*(){const o=yield n.utilsSvc.loading();yield o.present();const{latitude:a,longitude:c,altitude:r}=(yield n.getCurrentLocation())||{};n.latitude=a,n.longitude=c,n.altitude=void 0!==r?r:"N/A";const s=new Date;n.currentDate=s.toLocaleDateString(),n.currentTime=s.toLocaleTimeString();try{const g=n.firebaseSvc.getSeccionPorId(t),p=g.then(D=>n.firebaseSvc.getAsignaturaPorId(D.asignatura)),[v,m]=yield Promise.all([g,p]);if(n.seccion=v,n.asignatura=m,n.seccion&&n.seccion.profesor){const D=yield n.firebaseSvc.getUserById(n.seccion.profesor);n.seccion.profesor=D?`${D.name} ${D.lastname}`:"Nombre del Profesor"}console.log("Datos de la secci\xf3n:",n.seccion),console.log("Datos de la asignatura:",n.asignatura)}catch(g){console.error("Error al cargar secci\xf3n o asignatura:",g)}finally{o.dismiss()}})()}getCurrentLocation(){return(0,u.A)(function*(){try{var t;const n=yield T.L.getCurrentPosition({enableHighAccuracy:!0});return{latitude:n.coords.latitude,longitude:n.coords.longitude,altitude:null!==(t=n.coords.altitude)&&void 0!==t?t:0}}catch(n){return console.error("Error obteniendo la ubicaci\xf3n:",n),null}})()}startScan(){var t=this;return(0,u.A)(function*(){var n;const o=yield t.modalController.create({component:L,cssClass:"barcode-scanning-modal",showBackdrop:!1,componentProps:{formats:[],lensFacing:E.Back}});yield o.present();const{data:a}=yield o.onWillDismiss();if(null!=a&&null!==(n=a.barcode)&&void 0!==n&&n.displayValue){t.ScanResult=a.barcode.displayValue;const c=t.extractUID(t.ScanResult);if(t.isUIDAlreadyScanned(c))return void t.utilsSvc.showToast("Este c\xf3digo QR ya ha sido escaneado anteriormente.");const r=yield t.validateSection(t.ScanResult),s=t.validateDate(t.ScanResult),g=yield t.validatePosition(t.ScanResult);r&&s&&g?(yield t.Marcar(),t.saveUIDToLocalStorage(c)):t.utilsSvc.showToast("El c\xf3digo QR no es v\xe1lido: secci\xf3n, fecha o posici\xf3n incorrecta.")}else console.log("No se escane\xf3 un c\xf3digo QR v\xe1lido.")})()}extractUID(t){const o=t.match(/UID:\s*([^,]+)/);return o&&o[1]?o[1].trim():(console.error("No se pudo extraer el UID del QR"),"")}isUIDAlreadyScanned(t){const n=localStorage.getItem("scannedUIDs");return!!n&&JSON.parse(n).includes(t)}saveUIDToLocalStorage(t){const n=localStorage.getItem("scannedUIDs");let o=n?JSON.parse(n):[];o.push(t),localStorage.setItem("scannedUIDs",JSON.stringify(o))}validateSection(t){var n=this;return(0,u.A)(function*(){try{var o;return n.extractSeccionName(t)===(null===(o=n.seccion)||void 0===o?void 0:o.uid)}catch(a){return console.error("Error al validar la secci\xf3n:",a),!1}})()}extractSeccionName(t){const o=t.match(/Secci\xf3n:\s*([^,]+)/);return o&&o[1]?o[1].trim():(console.error("No se pudo extraer el nombre de la secci\xf3n del QR"),"")}validateDate(t){const o=t.match(/Fecha:\s*([^,]+)/);if(o&&o[1]){const a=o[1].trim(),c=(new Date).toLocaleDateString();return console.log("Fecha QR:",a),console.log("Fecha actual:",c),a===c}return console.error("No se pudo extraer la fecha del QR"),!1}validatePosition(t){var n=this;return(0,u.A)(function*(){try{const o=n.extractPosition(t);return o?n.latitude&&n.longitude?n.calculateDistance(n.latitude,n.longitude,o.latitude,o.longitude)<=100:(console.error("No se obtuvo la ubicaci\xf3n actual"),!1):(console.error("No se pudo extraer la posici\xf3n del QR"),!1)}catch(o){return console.error("Error al validar la posici\xf3n:",o),!1}})()}extractPosition(t){const o=t.match(/Ubicaci\xf3n:\s*([^,]+),\s*([^,]+),\s*([^,]+)/);return o&&o[1]&&o[2]&&o[3]?{latitude:parseFloat(o[1].trim()),longitude:parseFloat(o[2].trim()),altitude:parseFloat(o[3].trim())}:(console.error("No se pudo extraer la ubicaci\xf3n del QR"),null)}calculateDistance(t,n,o,a){const r=t*Math.PI/180,s=o*Math.PI/180,g=(o-t)*Math.PI/180,p=(a-n)*Math.PI/180,v=Math.sin(g/2)*Math.sin(g/2)+Math.cos(r)*Math.cos(s)*Math.sin(p/2)*Math.sin(p/2);return 2*Math.atan2(Math.sqrt(v),Math.sqrt(1-v))*6371e3}registerAttendance(t){var n=this;return(0,u.A)(function*(){try{var o;const c=localStorage.getItem("userUid"),r=yield n.firebaseSvc.obtenerAsistenciaEstudiantePorSeccion(c,null===(o=n.seccion)||void 0===o?void 0:o.uid);if(r&&r.length>0){const s=r[0],g=(s.total_asistencia||0)+1;console.log("ID del documento:",s.id),yield n.firebaseSvc.actualizarAsistencia(s.id,g),console.log("Asistencia actualizada con \xe9xito")}else{var a;const s={estudiante_id:c,seccion_id:null===(a=n.seccion)||void 0===a?void 0:a.uid,total_asistencia:1};yield n.firebaseSvc.crearAsistencia(s),console.log("Nuevo registro de asistencia creado con \xe9xito")}}catch(c){console.error("Error al registrar asistencia:",c)}})()}Marcar(){var t=this;return(0,u.A)(function*(){const n=yield t.createAlert("Registrar asistencia","\xbfAcepta registrar asistencia?");yield n.present(),"confirm"===(yield n.onDidDismiss()).role&&(yield t.registerAttendance(t.ScanResult))})()}createAlert(t,n){var o=this;return(0,u.A)(function*(){return yield o.alertController.create({header:t,message:n,backdropDismiss:!1,buttons:[{text:"Cancelar",role:"cancel",handler:()=>console.log("Bot\xf3n Cancelar")},{text:"OK",role:"confirm",handler:()=>o.navegar()}]})})()}navegar(){this.utilsSvc.routerLink("/main-estudiante/home")}}return(e=f).\u0275fac=function(t){return new(t||e)(i.rXU(l.hG),i.rXU(l._t),i.rXU(l.W3),i.rXU(b.nX))},e.\u0275cmp=i.VBU({type:e,selectors:[["app-marcar"]],decls:25,vars:8,consts:[["titulo","Asistencia"],[1,"ion-padding"],[1,"segment-content"],["src","../../../assets/img/plantilla.png","alt","Qr-ejemplo",1,"ion-padding"],[1,"ion-text-center"],["color","tertiary","shape","round","expand","block",1,"ion-padding",3,"click"],["slot","end","name","scan-outline"]],template:function(t,n){1&t&&(i.nrm(0,"app-encabezado",0),i.j41(1,"ion-content",1)(2,"ion-item")(3,"ion-label")(4,"h1"),i.EFF(5),i.k0s(),i.j41(6,"p"),i.EFF(7),i.k0s(),i.j41(8,"p"),i.EFF(9),i.k0s()()(),i.j41(10,"ion-item")(11,"ion-label")(12,"h2"),i.EFF(13,"Informaci\xf3n"),i.k0s(),i.j41(14,"p"),i.EFF(15),i.k0s(),i.j41(16,"p"),i.EFF(17),i.k0s()()(),i.j41(18,"div",2),i.nrm(19,"img",3),i.j41(20,"h6",4),i.EFF(21,"Escanea para registrar tu Asistencia"),i.k0s()(),i.j41(22,"ion-button",5),i.bIt("click",function(){return n.startScan()}),i.EFF(23," Marcar "),i.nrm(24,"ion-icon",6),i.k0s()()),2&t&&(i.R7$(5),i.JRh((null==n.asignatura?null:n.asignatura.nombre)||"Nombre de la Asignatura"),i.R7$(2),i.SpI("Profesor: ",null==n.seccion?null:n.seccion.profesor,""),i.R7$(2),i.SpI("Aula: ",(null==n.seccion?null:n.seccion.aula)||"Aula",""),i.R7$(6),i.Lme("Fecha: ",n.currentDate,"_____Hora: ",n.currentTime,""),i.R7$(2),i.E5c("Ubicacion: ",n.latitude,", ",n.longitude,", ",n.altitude,""))},dependencies:[l.Jm,l.W9,l.iq,l.uz,l.he,x.w]}),f})()}];let j=(()=>{var e;class f{}return(e=f).\u0275fac=function(t){return new(t||e)},e.\u0275mod=i.$C({type:e}),e.\u0275inj=i.G2t({imports:[b.iI.forChild(w),b.iI]}),f})();var Q=d(5553);let W=(()=>{var e;class f{}return(e=f).\u0275fac=function(t){return new(t||e)},e.\u0275mod=i.$C({type:e}),e.\u0275inj=i.G2t({imports:[C.MD,N.YN,l.bv,j,Q.h]}),f})()}}]);